---
layout: feature
title: Email API
description: Generic Email Service to send template based emails
date: 2013-04-06 23:39:29
thumbnail: /images/email-api/thumbnail.png
categories: features
tags: new

---


## Purpose
The **EmailService** provides APIs for sending emails through a centrally configured service. 
It uses an email template which is stored in the CRX repository inside  `/etc/notifications/`. 
You can create author-able templates so that the developers do not need to be involved in creating and updating email templates. 

## Email API definition

`com.adobe.acs.commons.email` 
### **Class EmailService** ###

[java.lang.Object](http://docs.oracle.com/javase/1.5.0/docs/api/java/lang/Object.html?is-external=true)
-> com.adobe.acs.commons.email.EmailService
	
 
	 boolean  | sendEmail(String templatePath, Map<String, String> emailParams, InternetAddress... recipients)  
	 boolean  | sendEmail(String templatePath, Map<String, String> emailParams, String... recipients)  

### Method detail ###
	
	public boolean sendEmail(String templatePath, Map<String, String> emailParams, InternetAddress... recipients);

**Description:**  
Sends an email to atleast one recipient based on the template text specified by the templatePath and replacing variables in the template text using the emailParams.

**Parameters:**       

1. templatePath - An absolute path of the email template in the repository. eg: /etc/notification/email/emailTemplate.txt.  
2. emailParams  - Map containing template variable [name : value] that is injected in the email.     
3. recipients   - A variable array of recipients email addresses of type InternetAddress. 

**Returns:**  
boolean  
true - if email is sent sucessfully,  
false otherwise.


	public boolean sendEmail(String templatePath, Map<String, String> emailParams, String... recipients);

**Description:**  
Sends an email to atleast one recipient based on the template text specified by the templatePath and replacing variables in the template text using the emailParams. This API internally calls sendEmail() method with param recipients type InternetAddress.

**Parameters:**       

1. templatePath - An absolute path of the email template in the repository. eg: /etc/notification/email/emailTemplate.txt.  
2. emailParams  - Map containing template variable [name : value] that is injected in the email.     
3. recipients   - A variable array of recipients email addresses of type String. 

**Returns:**  
boolean  
true - if email is sent sucessfully,  
false otherwise.

## How to Use
	
#### Configuring the MAIL SERVICE
The first step to sending emails through CQ is to configure the  CQ Mail Service.  To do this, log into to the OSGi Console at `{server}:{port}/system/console/configMgr ` and look for a service called **Mail Service**.
For CQ to be able to send emails, the Day CQ Mail Service needs to be properly configured. You can view the configuration in the Felix web console. 

The following constraints apply:

- The **SMTP server port** must be 25 or higher.
- The **SMTP server host** name must not be blank.
- The **"From" address** must not be blank.

Enter all of the relevant information for your current SMTP provider.  If you don't have or can't easily get SMTP set up within your organization, a Gmail account works for testing.

Once you have the Day CQ Mail Service configured you should be able to send emails.  If, later on you run into problems with getting a null Message Gateway, you probably entered something incorrectly here.
The configuration looks as follows in the web console:

![image]({{ site.baseurl }}/images/email-api/mail-service-config.png)

#### Creating an Email Template 

Templates are nt:file nodes in the repository representing a text file.
The text file contains the complete email. Email headers are defined as the first lines of the file in the format Header-Name: Header-Value, one header per line. Headers supporting multiple values can thus have several header lines. The supported headers are the standard email headers.

After the last header line put an empty line and start the email body afterwards.
The templates are simple texts files. 

Below is a sample Email Template file. All of the text in the format ${variable} will be replaced with the variable matching the name inside the brackets.  These variables are injected dynamically by this API.  

![image]({{ site.baseurl }}/images/email-api/email-template.png)

Once you have created the template, upload it inside `/etc/notifications` using the CQ Tools manager.


#### Using the Email API to send mails ####

**Invoking the Email API from your  JSP**   
The Emailservice can be invoked using sling.getService() method inside your jsp file.

	EmailService emailService = sling.getService(EmailService.class);

	emailService.sendEmail(templatePath, emailParams, recipients);


**Invoking the Email API from a OSGi Service class**  
The EmailService is an OSGi service and can be injected using @Reference in the calling class.

	@Reference
	EmailService emailService;

	emailService.sendEmail(templatePath, emailParams, recipients);

**Invoking the Email API from a Java class which is not an OSGi service**  
The EmailService can be invoked like any Java API.

	EmailService emailService = new EmailServiceImpl();
	
	emailService.sendEmail(templatePath, emailParams, recipients);

## Example
Example of a code snippet that uses the EmailService Api to sent email is show below:
 
	<%@include file="/libs/foundation/global.jsp"%>
	<%@page import="com.adobe.acs.commons.email.EmailService,
	        java.util.*"%>

	<%
	EmailService emailService = sling.getService(EmailService.class);

	String templatePath = "/etc/notifications/email/emailTemplate.txt";

	//Set the dynamic vaiables of your email template
	Map<String, String> emailParams = new HashMap<String,String>();
	emailParams.put("body","hello there");

	//customize the sender email address - if required
	emailParams.put("senderEmailAddress","abcd@example.com");
	emailParams.put("senderName","David Smith");

	String recipients = {"recipient1@example.com", "recipient2@example.com"};

	EmailService emailService = sling.getService(EmailService.class);

	boolean emailSent = emailService.sendEmail(templatePath, emailParams, recipients);

	if(emailSent == true) {
		out.println("Email sent successfully to the recipients");
	}
	else {
		out.println("Email sent failed");
	}

	%>

